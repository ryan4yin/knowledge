
## 一、控制数据面 proxy 的启动、终止顺序

### 预先启动 proxy，或者说在 proxy 启动后再启动其他容器

Istio 1.7 新增了一个功能: [delay the application start until after the sidecar is started](https://istio.io/latest/news/releases/1.7.x/announcing-1.7/change-notes/#traffic-management)

通过设置 operator 参数 `values.global.proxy.holdApplicationUntilProxyStarts=true`，就能全局启用此功能，让主容器在 Sidecar 就绪后启动，避免主容器因为网络未就绪而 Crash.

或者在 pod 上添加如下注解也是一样的效果（只在该 pod 上生效）：

```yaml
      annotations:
        # https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#ProxyConfig
        proxy.istio.io/config: |
          holdApplicationUntilProxyStarts: true
```

建议：通常只有一启动就需要访问外部网络的服务，会有这个问题，因此我认为应该按需在每个 Pod 上启用此功能，没必要改全局配置。

### 为主容器及 Sidecar 均添加 preStop 参数

>https://github.com/hashicorp/consul-k8s/issues/650

首先，我在 [K8s 最佳实践](./../../最佳实践.md) 的「优雅停止（Gracful Shutdown）与 502/504 报错」详细说明过，为什么要为 Pod 添加 `preStop`.

在 Sidecar 代理了 Pod 流量的情况下，上述问题会变得更复杂一点——还需要考虑一个关闭顺序的问题：

- 如果在 Envoy 已关闭，有新的请求再进来，将会导致 504
  - 所以 Envoy 最好在 Terminating 至少 3s 后才能关，确保 Istio 网格配置已完全更新
- 如果在 Envoy 还没停止时，主容器先关闭，然后又有新的请求再进来，Envoy 将因为无法连接到 upstream 导致 503
  - 所以主容器也最好在 Terminating 至少 3s 后，才能关闭。
- 如果主容器处理还未处理完遗留请求时，Envoy 或者主容器的其中一个停止了，会因为 tcp 连接直接断开连接导致 502
  - 因此 Envoy 必须在主容器处理完遗留请求后（即没有 tcp 连接时），才能关闭

所以总结下：Envoy 及主容器的 `preStop` 都至少得设成 3s，并且在「没有 tcp 连接」时，才能关闭，避免出现 502/503/504.

主容器的修改方法在前文中已经写过了，下面介绍下 Envoy 的修改方法。

和主容器一样，Envoy 也能直接加 `preStop`，修改 `istio-sidecar-injector` 这个 `configmap`，在 sidecar 里添加 preStop sleep 命令:

```yaml
    containers:
    - name: istio-proxy
      # 添加下面这部分
      lifecycle:
      preStop:
          exec:
            command:
            - /bin/sh
            - -c
            - "while [ $(netstat -plunt | grep tcp | grep -v envoy | wc -l | xargs) -ne 0 ]; do sleep 1; done"
```

#### 无效的手段

直接设置 `terminationDrainDuration`，Envoy 会因为被终止，而在 Terminating 的一瞬间立即开始拒绝新的 TCP 连接，只等待旧连接关闭。
如果这时 Istio 网格配置还没完全更新，就可能遇到 tcp 连接被 Envoy 拒绝的情况。

如果客户端也有 Enovy 做正向代理，这个客户端 Envoy 可能会报错 503.

因此如下配置不适用：

```yaml
annotations:
  # https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#ProxyConfig
  proxy.istio.io/config: |
    terminationDrainDuration: 30s
```

必须得通过 preStop 来延迟 Envoy 收到 SIGTERM 信号的时间，至少延迟个 3s 吧。


## [转发客户端 IP/证书](https://istio.io/latest/docs/ops/configuration/traffic-management/network-topologies/)


全局配置：

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  meshConfig:
    defaultConfig:
      gatewayTopology:
        numTrustedProxies: 2
        forwardClientCertDetails: APPEND_FORWARD  # 通常只在使用 mTLS 双向认证时，服务端才会要求转发证书
```

pod 级别的配置：

```yaml
...
  metadata:
    annotations:
      "proxy.istio.io/config": '{"gatewayTopology" : { "numTrustedProxies": 2, "forwardClientCertDetails": APPEND_FORWARD } }'
```



## 二、Pod 预热功能 - slow start

目前 Istio 仍然欠缺类似 [AWS ALB](https://aws.amazon.com/about-aws/whats-new/2018/05/application-load-balancer-announces-slow-start-support/)/[nginx](http://nginx.org/en/docs/http/ngx_http_upstream_module.html#slow_start) 的 `slow_start` 的能力，缓慢地将流量切给新建的 Pods，相关进展如下：

- Istio 1.11 目前还没有进展：[Ability to gradually warm services - Istio issues](https://github.com/istio/istio/issues/21228)
- Envoy 1.20+ 已支持 slow_start 模式：[Slow start mode - envoy](https://www.envoyproxy.io/docs/envoy/v1.20.0/intro/arch_overview/upstream/load_balancing/slow_start#arch-overview-load-balancing-slow-start)


## 三、HPA 扩缩容

Pod 在添加 Sidecar 后，HPA 扩缩容的指标会受到影响。

参见 [Horizontal Pod Autoscaler - Pod 自动扩缩容](../../autoscaling/Horizontal%20Pod%20Autoscaler.md)
