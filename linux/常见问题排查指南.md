# 常见问题排查指南


## CPU 突增至 100%

1. 内存用尽


## 磁盘空间告急

在 Linux 或者 Unix 系统中，直接手动删除文件将会从文件系统的目录结构上解除该文件的链接（unlink），然而如果文件被删除时仍然有一个进程正在使用它，那么该进程仍然可以读取此文件，磁盘空间也会一直被占用。
因此如果因为日志等文件不断增长导致空间告急，直接删除这些日志文件是没有用的！

正确的操作是使用 echo 等命令清空文件：

```
# 直接清空日志文件（文件将仅包含一个换行符）
echo "" > /path/xxx.log

# 只保留最新的 10000 行日志
tail -n 10000 /path/xxx.log > /path/xxx_tail.log
cat /path/xxx_tail.log > /path/xxx.log
rm /path/xxx_tail.log
```

### 手动删除文件后的补救办法

手动删除文件后，通过 `df -h` 会发现磁盘空间没有变化，但是使用 `sudo du -sh /*` 却可以看到文件夹变小了。
这时使用如下命令，就能查找到仍然未关闭的文件描述符，以及对应的进程 id:

```shell
lsof | grep delete
```

解决方法：

- 最简单有效的方法，就是关闭或者重启正在占用文件的进程。但是可能会造成中断，需要在搞清楚影响后再确认何时进行操作。
- 对于日志文件，在紧急情况下也有更简单的方法：`echo "" > /proc/<pid>/fd/<fd>` 直接通过 `/proc` 清空仍然被占用的文件。之后再另找时间重启这个进程。



